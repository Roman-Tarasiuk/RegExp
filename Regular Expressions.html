<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Regular Expressions</title>
    <link rel="shortcut icon" href="img/icon_RegExp.png">
    <link rel="stylesheet" type="text/css" href="css/regular_expressions.css">
    <script src="scripts.library.js"></script>
</head>

<body>
    <div>
        <p class="regularExpressionsPluginP">Input:</p>
        <textarea id="input" class="w" style="height: 100px;"
            onchange="inputChanged()"
            onpaste="inputPaste()"
            onkeyup="inputKeyup()"></textarea>
        <div class="hover">
            <button onclick="clearData('input'); showInfo('info1', '...')">Clear</button>
            <span style="display: inline-block; width: 30px;"></span>
            <input id="userFile" type="file" onchange="onChange(event)"></input>
            <span>Encoding:</span>
            <input id="encoding" value="Windows-1251"></input>
            <button onclick="showFile()">Show file content</button>
            <span id="info1" class="info">...</span>
        </div>
    </div>

    <div>
        <span class="description regularExpressionsPluginP">Regular expression:</span>
        <textarea id="regexp" class="w2" style="height: 22px; margin-top: 4px;">
<td><b>(.*?)</b>( .*?)<br>(?:<a href="mailto:(.*?@.*?)">)?.*\n\s*<td>(.*?)</td></textarea>
        <br>
        <span class="description regularExpressionsPluginP">Flags:</span>
        <input type=text id="flags" style="height: 22px; margin-top: 4px;" value="g" placeholder="gmi"></textarea>
    </div>

    <div>
        <span class="description regularExpressionsPluginP">Results patterrn / Replace to:</span>
        <textarea id="resultsPattern" class="w3" style="height: 22px; margin-top: 4px;"
            placeholder="match[1] + match[2] + '\t' + match[3] + '\t' + fileName + '\n'">
match[1] + '\t' + fileName + '\n'</textarea>

        <div id="regularExpressionsPluginSets" style="margin-bottom: 6px; margin-top: -3px;">
            <button onclick="saveSet(false)" style="color: red; margin-left: 10px;">Save set</button>
        </div>
    </div>

    <div>
        <button onclick="process()" style="font-weight: bold;">All matches</button>
        <button onclick="processReplace()" style="font-weight: bold;">Replace</button>

        <span id="info2" class="info">...</span>
        
        <p class="regularExpressionsPluginP">Results:</p>
        <textarea id="results" class="w" style="height: 100px;"></textarea>

        <div class="hover">
            <button onclick="clearData('results')">Clear</button>
        </div>
    </div>

    <div>
        <p class="regularExpressionsPluginP">Read more about
            <a href="Regular Expressions - JavaScript _ MDN.html"  target="_blank">Regular Expressions</a>
            and
            <a href="RegExp - JavaScript _ MDN.html"  target="_blank">RegExp</a>
        </p>
        <div class="regularExpressionsPluginP">
        <p class="zero-margin-bottom">Some text utilities:</p>
        <ul class="zero-margin-top">
            <li><a href="string_operations.html">String operations</a></li>
            <li><a href="utils.html">Utils</a></li>
        </ul>
        </div>
    </div>

    <script>
        //
        // !! Maybe next info is not actual !!
        //
        // To embed this page into other page (e.g. over Greasemonkey in Mozilla Firefox)
        //
        // 1. Define variables:
        // var replaceCookiesOrigin = ';';
        // var replaceCookiesRE = new RegExp(replaceCookiesOrigin, 'g');
        // var replaceCookiesStr = '###';
        // var replaceCookiesBackRE = new RegExp(replaceCookiesStr, 'g');
        //
        // 2. Define process() as window.process = function () {...};
        //    define saveSet() and getSetsFromCookies() in the same way.
        //
        // 3. For correct using double quotes, make next replacements in body html (+ 2 comments below or desired instead of them) content:
        // " -> \"         (normal)
        // \ -> \\         (normal)
        // \\" -> \"       (normal)
        // \r\n -> \\\r\n  (extended)
        //
        // 4. Append result into code (divRegularExpressions.innerHTML):
        // window.getSource = function () {
        //   document.getElementById('input').value = document.body.innerHTML;
        // }
        //
        // var div = document.createElement('div');
        // div.setAttribute('id', 'regularExpressionsPlugin');
        // div.setAttribute('style', 'border: 2px solid green; padding: 5px; margin: 2px;');
        //
        // var divBtn = document.createElement('div');
        // divBtn.innerHTML = '<button onclick="getSource()">Get page source</button>';
        //
        // div.appendChild(divBtn);
        //
        // var divRegularExpressions = document.createElement('div');
        // divRegularExpressions.innerHTML = "*** *** *** PUT MODIFIED HTML HERE INTO DOUBLE QUOTES *** *** ***";
        //
        // div.appendChild(divRegularExpressions);
        //
        // document.body.appendChild(div);
        //
        // var style = document.createElement('style');
        // style.innerHTML = '\
        //     .regularExpressionsPluginP {\
        //         margin: 0;\
        //         font-weight: bold;\
        //     }';
        //
        // document.head.appendChild(style);
        //
        // getSetsFromCookies();
        //
        // 5. Move result regular expression and results pattern into html for auto loading.
        //
        //
        // branch RE: <a href="http:\/\/www.kv.aval\/ua\/phone_list.html\?rootId=\d*" (style="cursor:pointer;">)(.*?)</a>(?:.*?\1(.*?)</a>(?:.*?\1(.*?)</a>(?:.*?\1(.*?)</a>(?:.*?\1(.*?)</a>)?)?)?)?
        // results  : match[2] + ' -> ' + match[3] + ' -> ' + match[4] + ' -> ' + match[5] + ' -> ' + match[6]
        //
        // phones RE: <td><b>(.*?)</b>( .*?)<br>(?:<a href="mailto:(.*?@.*?)">)?.*\n\s*<td>(.*?)</td>
        // results  : match[1] + match[2] + '\t' + match[3] + '\t' + match[4]

        var inputElement = document.getElementById('input');
        var replaceCookiesOrigin = ';';
        var replaceCookiesRE = new RegExp(replaceCookiesOrigin, 'g');
        var replaceCookiesStr = '###';
        var replaceCookiesBackRE = new RegExp(replaceCookiesStr, 'g');
        var fileName = '';
        var userInputChanged = false;
        var input = '';

        function clearData(inp) {
            var input = document.getElementById(inp);
            input.focus();
            input.value = "";
            showInfo('info2', '...');
        }

        function process() {
            var rePattern = document.getElementById('regexp').value
                    .replace(/\\\n/g, '\n');
            var reFlags = document.getElementById('flags').value;
            var resultsPattern = document.getElementById('resultsPattern').value;

            var RE = new RegExp(rePattern, reFlags);
            
            console.log('RE:');
            console.log(RE);

            if (userInputChanged) {
                input = inputElement.value;
                userInputChanged = false;
            }

            var resultsCtrl = document.getElementById('results');

            resultsCtrl.value = '';

            var count = 0;
            var resultsStr = '';

            var match;
            while ((match = RE.exec(input)) != null && (match.index < input.length) && (resultsStr.length <= input.length * 10)) {
                resultsStr += eval(resultsPattern);
                count++;
            }

            if (count == 0) {
                resultsCtrl.value = 'No matches...';
            }
            else {
                resultsCtrl.value = resultsStr;
                showInfo('info2', '(' + count + ' match(es) found)');
            }
        }

        function processReplace() {
            var rePattern = document.getElementById('regexp').value;
            var reFlags = document.getElementById('flags').value;
            var resultsPattern = document.getElementById('resultsPattern').value;

            var RE = new RegExp(rePattern, reFlags);

            if (userInputChanged) {
                input = inputElement.value;
                userInputChanged = false;
            }

            var resultsCtrl = document.getElementById('results');

            resultsCtrl.value = '';

            var resultsStr = input.replace(RE, resultsPattern);

            resultsCtrl.value = resultsStr;
        }

        function saveSet(readFromCookies, ID) {
            if (window.regularExpressionsPluginSetsArray == undefined) {
                window.regularExpressionsPluginSetsArray = [];
            }

            if (!readFromCookies) {
                var id = 'regularExpressionsPluginSets' + window.regularExpressionsPluginSetsArray.length;
            }
            else {
                var id = 'regularExpressionsPluginSets' + ID;
            }

            var radio = document.createElement('input');
            radio.setAttribute('type', 'radio');
            radio.setAttribute('id', id);
            radio.setAttribute('name', 'regularExpressionsPluginSets');
            radio.addEventListener('click', window.selectSet = function (event) {
                var index = parseInt(event.target.id.substring('regularExpressionsPluginSets'.length));
                console.log(index + ' set selected');

                document.getElementById('regexp').value = window.regularExpressionsPluginSetsArray[index].re;
                document.getElementById('resultsPattern').value = window.regularExpressionsPluginSetsArray[index].resPatt;
            });

            var label = document.createElement('label');
            label.setAttribute('for', 'regularExpressionsPluginSets' + window.regularExpressionsPluginSetsArray.length);
            label.innerText = (!readFromCookies) ? regularExpressionsPluginSetsArray.length : ID;

            document.getElementById('regularExpressionsPluginSets').appendChild(radio);
            document.getElementById('regularExpressionsPluginSets').appendChild(label);

            if (!readFromCookies) {
                var re = document.getElementById('regexp').value;
                var resPatt = document.getElementById('resultsPattern').value;

                regularExpressionsPluginSetsArray.push({re: re, resPatt: resPatt});

                var cookieStr = JSON.stringify(regularExpressionsPluginSetsArray);
                cookieStr = cookieStr.replace(replaceCookiesRE, replaceCookiesStr);

                setCookie('regularExpressionsPlugin', cookieStr, 1000);
            }
        }

        function getSetsFromCookies() {
            console.log(' ');

            var cookie = getCookie('regularExpressionsPlugin');

            if (cookie == '') {
                return;
            }

            window.regularExpressionsPluginSetsArray = JSON.parse(cookie.replace(replaceCookiesBackRE, replaceCookiesOrigin));

            for (var i = 0; i < regularExpressionsPluginSetsArray.length; i++) {
                document.getElementById('regexp').value = regularExpressionsPluginSetsArray[i].re;
                document.getElementById('resultsPattern').value = regularExpressionsPluginSetsArray[i].resPatt;
                saveSet(true, i);
            }
        }

        getSetsFromCookies();
        
        function onChange(event) {
          var file = event.target.files[0];
          fileName = file.name;
          var encoding = document.getElementById('encoding').value;
          
          var reader = new FileReader();
          reader.onload = function(event) {
            //inputElement.value = event.target.result;
            input = event.target.result;
            userInputChanged = false;
            inputElement.value = '\'' + fileName + '\' is successfully loaded.';
            showInfo('info1', 'The input length: ' + input.length);
          };

          reader.readAsText(file, encoding);
        }
        
        function showInfo(id, text) {
            document.getElementById(id).innerText = text;
        }
        
        function inputChanged() {
            console.log('** Input changed.');
            userInputChanged = true;
            showInfo('info1', 'The input length: ' + inputElement.value.length);
        }
        
        function inputPaste() {
            console.log('** Input pasted.');
            userInputChanged = true;
            showInfo('info1', 'The input length: ' + inputElement.value.length);
        }
        
        function inputKeyup() {
            console.log('** Input key up.');
            userInputChanged = true;
            showInfo('info1', 'The input length: ' + inputElement.value.length);
        }
        
        function showFile() {
            inputElement.value = input;
            input = inputElement.value;
            showInfo('info1', 'The input length: ' + input.length);
        }
    </script>
</body>
</html>