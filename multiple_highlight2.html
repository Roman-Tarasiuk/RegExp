<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Multiple highlight</title>

    <style>
        .description {
            color: grey;
            margin-bottom: 0;
        }

        .p {
            border: 1px solid grey;
            margin-top: 0;
            white-space: pre;
            font-family: Consolas, monaco, monospace;
        }

        .input {
            background-color: #def;
        }

        .result {
            background-color: #dfd;
        }

        .selection-processed {
            background-color: #3399ff;
        }

        .container {
            margin-top: 8px;
        }

        .container-txt {
            overflow: scroll;
            resize: both;
            width: 100%;
        }

        .container-input {
            height: 200px;
        }

        .container-result {
            height: 460px;
        }
    </style>
</head>
<body>
    <textarea id="input" style="width: 100%; height: 150px;"
                onkeyup = "helperObject.userInput()"
                onchange = "helperObject.userInput()"
                placeholder="Put any text here (HTML page source may work with some troubles)."></textarea>

    <button onclick="helperObject.userInput(); helperObject.parameters()">Apply</button>
    <button onclick="helperObject.clearInput()">Clear</button>

    <span>Select/result width: </span>
    <input id="width" type="text" value="100%"></input>

    <div class="container">
        <label class="description">Select here:</label>
        <div id="txt1" class="container-txt container-input">
            <code>
                <p id="selection" class="p input"
                    onmousedown="helperObject.mouseDown()"
                    onmouseup="helperObject.mouseUp()"></p>
            </code>
        </div>
    </div>

    <div class="container">
        <label class="description">Results:</label>
        <div id="txt2" class="container-txt container-result">
            <code>
                <p id="result" class="p result"></p>
            </code>
        </div>
    </div>

    <script>
        var helperObject;
        (function(helperObject) {

            var mouseDown = false;
            var selectionChanged = false;
            var selectionProcessing = false;

            var inputCtrl = document.getElementById('input');
            var selectionCtrl = document.getElementById('selection');
            var resultCtrl = document.getElementById('result');
            var widthCtrl = document.getElementById('width');


            helperObject.userInput = function() {
                var input = inputCtrl.value;
                input = replaceAngleBrackets(input);

                selectionCtrl.innerHTML = input;
                resultCtrl.innerHTML = input;
            }

            helperObject.parameters = function() {
                document.querySelector('#txt1').style.width = widthCtrl.value;
                document.querySelector('#txt2').style.width = widthCtrl.value;
            }

            helperObject.clearInput = function() {
                inputCtrl.value = "";
                selectionCtrl.innerHTML = "";
                resultCtrl.innerHTML = "";

                inputCtrl.focus();
            }

            function replaceAngleBrackets(input) {
                input = input.replace(/</g, '&lt');
                input = input.replace(/>/g, '&gt');

                return input;
            }

            document.onselectionchange = function(e) {
                selectionChanged = true;
            };

            helperObject.mouseDown = function() {
                mouseDown = true;
            }

            helperObject.mouseUp = function() {
                mouseDown = false;
            }

            setInterval(function() {
                if (!selectionChanged || mouseDown) {
                    return;
                }

                if (selectionProcessing) {
                    return;
                }

                selectionProcessing = true;

                processSelection();

                selectionProcessing = false;
                selectionChanged = false;
            }, 100);

            function processSelection() {
                //console.log('Processed.');

                var selection = window.getSelection();
                //console.log(selection);

                var txt = "";

                var start = selection.anchorOffset;
                var end = selection.focusOffset;
                try {
                    txt = selection.anchorNode.textContent.substring(start, end);
                }
                catch {
                    return;
                }
                
                if (txt == '') {
                    return;
                }

                var replaceRe = new RegExp('(' + txt + ')', 'gi');

                //var resultTxt = inputCtrl.value.replace(replaceRe, '<span class="selection-processed">$1</span>');
                var resultTxt = replaceAngleBrackets(inputCtrl.value).replace(replaceRe, '<span class="selection-processed">$1</span>');

                resultCtrl.innerHTML = resultTxt;
            }
        })(helperObject || (helperObject = {}));
    </script>
</body>
</html>