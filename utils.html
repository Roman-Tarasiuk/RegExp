<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <!-- <link rel="stylesheet" type="text/css" href="css/style.css"> -->

    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/utils.css">

    <title>Utils</title>
    <link rel="shortcut icon" href="img/utilities.png">
</head>

<body style="background-color: #66f;">
    <div>
        <div id="request" style="width:1200px">
            <p id="comment">%-like address (e.g. Google search link):</p>
            <textarea id="googleAddress"></textarea>
            <button onclick="clearAndFocus('googleAddress')">Clear</button>
            <button onclick="document.getElementById('txt').value = decode()" id="btnClean">Decode</button>
            <button onclick="simpleEncode()">Simple encode</button>
            <button onclick="simpleDecode()">Simple decode</button>
        </div>
        <div id="result">
            <textarea id="txt" style="width:100%"></textarea>
        </div>
    </div>

    <div>
        <p>Now is:
            <span id="dateTimeNow" style="font-weight: normal" onclick="nowIs()" title="Click to refresh"></span>
        </p>
        <p id="clock" style="width: 155px; font-family: 'clockFont', sans-serif; font-size: 32pt; background-color: black; color: lime; padding-left: 4px; padding-right: 4px; margin: 0px;">00:00:00</p>
    </div>

    <br/>

    <div>
        <p>SQL:</p>
        <textarea id="sqlCode" style="width:1200px; background-color: #ffc;"></textarea>
        <br/>
        <button onclick="checkUncommentedSQL()">Check Uncommented</button>
        <button onclick="argumentSQL()">Argument</button>
    </div>

    <br/>

    <div>
        <p>Swap quotes &#39; &harr; &#34; (all or in a selection):</p>
        <textarea id="code" style="width:1200px"></textarea>
        <br/>
        <button onclick="swapQuotes()">Swap</button>
    </div>

    <br/>

    <div>
        <p>Statistic (occurrences of rows):</p>
        <textarea id="data" style="width:1200px"></textarea>
        <br/>
        <button onclick="clearAndFocus('data')">Clear</button>
        <button onclick="statistic()">Statistic</button>
        <button onclick="statisticCumulative()">Cumulative</button>
        <button onclick="statisticCategoryCount()">Category count</button>
        <button onclick="unique()">Unique</button>
    </div>


    <!-- <script src="js/script.js"></script> -->

    <script>
        String.prototype.replaceAll = function(search, replacement) {
            var target = this;
            return target.split(search).join(replacement);
        };
    
        (function() {
            var width = $('#request').width();
            // To Do: Hardcoded '33' and '8' - need to be computed automatically
            //$('#googleAddress').width(width - $('#comment').width() - $('#btnClean').width() - 36);
            $('#result').width(width - 8);
        })();

        //if (isInternetExplorer()) {
            $('#txt').resizable();
        //}

        function decode() {
            var address = document.getElementById('googleAddress').value;
            var addressPattern = /url=http.*&usg=/;
            var tmp = addressPattern.exec(address);

            var isFullAddress;
            if(tmp == null) {
                tmp = address;
                isFullAddress = true;
            }
            else {
                tmp = tmp.toString();
                isFullAddress = false;
            }

            /*
            var percentSymbols = ['%21', '%23', '%24', '%26', '%27', '%28', '%29', '%2A', '%2B', '%2C', '%2F', '%3A', '%3B', '%3D', '%3F', '%40', '%5B', '%5D',
                                  '%20', '%22', '%25', '%2D', '%2E', '%3C', '%3E', '%5C', '%5E', '%5F', '%60', '%7B', '%7C', '%7D', '%7E', '%C2%AE'];
            var normalSymbols  = [  '!',   '#',   '$',   '&',   "'",   '(',   ')',   '*',   '+',   ',',   '/',   ':',   ';',   '=',   '?',   '@',   '[',   ']',
                                    ' ',   '"',   '%',   '-',   '.',   '<',   '>',  '\\',   '^',   '_',   '`',   '{',   '|',   '}',   '~',      '®'];

            for(var i = 0; i < percentSymbols.length; i++) {
                if(tmp.indexOf(percentSymbols[i]) > 0) {
                    var re = new RegExp(percentSymbols[i], 'g');
                    tmp = tmp.replace(re, normalSymbols[i]);
                }
            }
            //*/

            //
            // http://meyerweb.com/eric/tools/dencoder/
            //
            //tmp = decodeURIComponent(tmp.replace(/\+/g,  ' '));
            tmp = decodeURIComponent(tmp);

            if(!isFullAddress) {
                tmp = tmp.slice(4, tmp.length - 5);
            }

            if(tmp.indexOf('%') > 0) {
                tmp = '%%%' + tmp;
            }

            return tmp;
        }

        function simpleEncode() {
            var origin = document.getElementById('googleAddress');
            var result = document.getElementById('txt');

            result.value = encodeURIComponent(origin.value);
        }

        function simpleDecode() {
            var origin = document.getElementById('googleAddress');
            var result = document.getElementById('txt');

            result.value = decodeURIComponent(origin.value);
        }

        function nowIs() {
            var d = new Date(Date.now());

            var month = d.getMonth() + 1;
            if (month.toString().length == 1) {
                month = '0' + month;
            }

            var date = d.getDate();
            if (date.toString().length == 1) {
                date = '0' + date;
            }

            var hours = d.getHours();
            if (hours.toString().length == 1) {
                hours = '0' + hours;
            }

            var minutes = d.getMinutes();
            if (minutes.toString().length == 1) {
                minutes = '0' + minutes;
            }

            var seconds = d.getSeconds();
            if (seconds.toString().length == 1) {
                seconds = '0' + seconds;
            }

            var s = '';
            s += d.getFullYear() + '-' + month + '-' + date + '--' + hours + '-' + minutes + '-' + seconds;

            document.getElementById('dateTimeNow').innerHTML = s;
        };

        nowIs();

        (function() {
            var showTime = function() {
                var d = new Date(Date.now());

                var hours = d.getHours();
                if (hours < 10) {
                    hours = '0' + hours;
                }

                var minutes = d.getMinutes();
                if (minutes < 10) {
                    minutes = '0' + minutes;
                }

                var seconds = d.getSeconds();
                if (seconds < 10) {
                    seconds = '0' + seconds;
                }

                document.getElementById('clock').innerHTML = hours + ':' + minutes + ':' + seconds;
            }

            window.setInterval(showTime, 100);
        }
        )();

        function checkUncommentedSQL() {
            function isSpaceOrComment(str) {
                var index = 0;
                while (index < str.length) {
                    if ((str[index] == ' ') || (str[index] == '\t')) {
                        index++;
                    }
                    else {
                        break;
                    }
                }

                if (index == str.length) {
                    return true;
                }

                if (str[index] == '-') {
                    if ((index < str.length - 1) && (str[index + 1] == '-')) {
                        return true;
                    }
                    else {
                        return false;
                    }
                }
                else {
                    return false;
                }
            }

            var rows = document.getElementById('sqlCode').value.split('\n');

            var uncommentedFound = false;
            for (var i = 0; i < rows.length; i++) {
                if (!isSpaceOrComment(rows[i])) {
                    uncommentedFound = true;
                    break;
                }
            }

            if (uncommentedFound) {
                alert('Found uncommented line: ' + (i + 1));
            }
            else {
                alert('No uncommented lines found.');
            }
        }

        function argumentSQL() {
            // --:: $T1 TM_ACC_TMP2_TRM
            // --:: $C1 POST_DATE
            // --:: $C2 STATUS
            // select distinct T1.$C1 from $T1 T1
            //     where T1.$C2 is not null

            var argStr = '--::';

            var sqlCtrl = document.getElementById('sqlCode');

            var rows = sqlCtrl.value.split('\n');
            var replacements = [];
            var resultStr = '';

            for (var i = 0; i < rows.length; i++) {
                if (rows[i].startsWith(argStr)) {
                    var arg = getArg(rows[i]);
                    if (arg != null) {
                        replacements.push(arg);
                    }
                    resultStr += rows[i] + '\n';
                }
                else {
                    resultStr += processArg(rows[i]) + '\n';
                }
            }

            sqlCtrl.value = resultStr;

            function getArg(str) {
                str = str.substring(argStr.length);
                str = str.trimLeft();

                var spaceIndex = str.indexOf(' ');

                var result;
                if (spaceIndex > 0) {
                    result = {
                        name: str.substring(0, spaceIndex),
                        value: str.substring(spaceIndex + 1)
                    };
                }
                else {
                    result = null;
                }

                return result;
            }

            function processArg(str) {
                for (var i = 0; i < replacements.length; i++) {
                    str = str.replaceAll(replacements[i].name, replacements[i].value);
                }

                return str;
            }
        }

        function swapQuotes() {
            var symbols = ['±'];

            var replacement = null;

            var code = document.getElementById('code');

            var text;

            if (code.selectionStart < code.selectionEnd) {
                text = code.value.substring(code.selectionStart, code.selectionEnd);
            }
            else {
                text = code.value;
            }

            for (var i = 0; i < symbols.length; i++) {
                if (text.indexOf(symbols[i]) == -1) {
                    replacement = symbols[i];
                    break;
                }
            }

            if (replacement != null) {
                text = text.replace(/\"/g, replacement);
                text = text.replace(/\'/g, '"');
                text = text.replace(new RegExp(replacement, 'g'), "'");

                if (code.selectionStart < code.selectionEnd) {
                    code.value =
                        code.value.substring(0, code.selectionStart)
                        + text
                        + code.value.substring(code.selectionEnd);
                }
                else {
                    code.value = text;
                }
            }
            else {
                code.value = 'Bad replacement symbols set.';
            }
        }

        function clearAndFocus(id) {
            var data = document.getElementById(id);
            data.focus();
            data.value = '';
        }

        function statistic() {
            var input = document.getElementById('data');
            var rows = input.value.split('\n');

            var stat = getStatistic(rows);

            var resultStr = '';
            for (var p in stat) {
                resultStr += p + '\t' + stat[p] + '\n';
            }

            input.value = resultStr;
        }

        function getStatistic(rows) {
            var result = {};

            for (var i = 0; i < rows.length; i++) {
                if (rows[i] in result) {
                    result[rows[i]]++;
                }
                else {
                    result[rows[i]] = 1;
                }
            }

            return result;
        }

        function statisticCumulative() {
            var input = document.getElementById('data');
            var rows = input.value.split('\n');

            var stat = getStatistic(rows);

            var resultStr = '';
            var tmp = {};

            for (var i = 0; i < rows.length; i++) {
                if (rows[i] in tmp) {
                    tmp[rows[i]]++;
                }
                else {
                    tmp[rows[i]] = 1;
                }

                resultStr += rows[i] + '\t' + tmp[rows[i]] + '/' + stat[rows[i]] + '\n';
            }

            input.value = resultStr;
        }

        function statisticCategoryCount() {
        // rows' format: subject \t category
            var input = document.getElementById('data');
            var rows = input.value.split('\n');

            var stat = {};
            var tmp = [];

            for (var i = 0; i < rows.length; i++) {
                var rowSplitted = rows[i].split('\t');
                var subj = rowSplitted[0];
                var cat = rowSplitted[1];
                if (subj in stat) {
                    if (!(cat in stat[subj])) {
                        stat[subj][cat] = null;
                        // The next two forms are equal.
                        //stat[subj].count++;
                        stat[subj]["count"]++;
                    }
                }
                else {
                    stat[subj] = {[cat]: null, count: 1};
                }

                tmp.push(subj);
                tmp.push(cat);
            }

            var resultStr = '';
            for (var i = 0; i < rows.length; i++) {
                resultStr += tmp[i * 2] + '\t' + tmp[i * 2 + 1] + '\t' + stat[tmp[i * 2]].count + '\n';
            }

            input.value = resultStr;
        }

        function unique() {
            var input = document.getElementById('data');
            var rows = input.value.split('\n');

            var stat = getStatistic(rows);

            var areUnique = true;
            for (var p in stat) {
                if (stat[p] > 1) {
                    areUnique = false;
                    break;
                }
            }

            if (areUnique) {
                alert('Rows are unique.');
            }
            else {
                alert('Rows are NOT unique.');
            }
        }
    </script>
</body>
</html>